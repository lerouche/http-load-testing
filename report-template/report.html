<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Here are your results</title>

        <style>
            <ZC-IMPORT[../node_modules/c3/c3.min.css]>
            <ZC-IMPORT[./report.css]>
        </style>

        <script>
            <ZC-IMPORT[../node_modules/d3/d3.min.js]>
            <ZC-IMPORT[../node_modules/c3/c3.min.js]>
            <ZC-IMPORT[../node_modules/jquery/dist/jquery.min.js]>

            $(function() {
                "use strict";

                var testSysloadCharts = [];
                var totalSysloadCharts = [];

                 function resizeCharts() {
                     requestsChart.resize({
                         height: document.documentElement.clientHeight - 45 - 45 - 20 - 20 - 50, // 50 is approximate for the article title's height + margin
                         width: document.documentElement.clientWidth - 40,
                     });
                     testSysloadCharts.forEach(function(chart) {
                         chart.resize({
                             width: document.documentElement.clientWidth - 40,
                         })
                     });
                     totalSysloadCharts.forEach(function(chart) {
                         chart.resize({
                             width: document.documentElement.clientWidth - 40,
                         })
                     });
                 }

                var json = <ZC-IMPORT[../report.json]>;

                $( 'h1' ).append(' ' + json.sysinfo.name);

                json.tests.forEach(function(testName) {
                    $( '#nav-tests-list' )
                        .append('<li data-id="test-' + testName.toLowerCase().replace(/ /g, '-') + '">' + testName + '</li>');
                });

                $( '#nav-list' )
                    .on('click', 'li[data-id]', function() {
                        if (!this.classList.contains('active')) {
                            location.hash = '#' + this.dataset.id;
                            $('#nav-list li.active').add(this).toggleClass('active');
                        }
                    });

                $( '#nav-tests-list-container' )
                    .on('click', function() {
                        $( '#nav-tests-list' ).toggleClass('open');
                    });

                Object.keys(json.errors).forEach(function(test) {
                    var $rows = Object.keys(json.errors[test]).map(function(subject) {
                        var errorsCount = json.errors[test][subject];
                        return $( '<tr><td>' + subject + '</td><td class="' + (errorsCount > 0 ? 'red' : '') + '">' + errorsCount + '</td></tr>' );
                    });
                    $rows[0].prepend('<td rowspan="' + $rows.length + '">' + test + '</td>' );
                    $rows.forEach(function($row) { $row.appendTo( '#errors-table > tbody' ); });
                });

                $( '#details-list > dt' ).each(function() {
                    var key = this.dataset.key;
                    var text = json.sysinfo[key];
                    switch (key) {
                        case 'sleepDuration':
                            text += ' seconds';
                            break;

                        case 'timeStarted':
                        case 'timeEnded':
                            text = new Date(text);
                            break;
                    }
                    $(this).next().text(text);
                });

                json.requestsChart.bindto = '#requests-chart';
                var requestsChart = c3.generate(json.requestsChart);

                Object.keys(json.testSysloadCharts).forEach(function(test) {
                    var chartConfig = json.testSysloadCharts[test];
                    var $article = $(document.importNode($( '#template-article-test-sysload' ).get(0).content, true).childNodes);
                    $article.appendTo( 'main' );
                    $article.prop('id', 'test-' + test.toLowerCase().replace(/ /g, '-'));
                    $article.children('h2').text(test);

                    testSysloadCharts.push(c3.generate(Object.assign(chartConfig.cpu, {
                        bindto: $article.find('.test-sysload-cpu-chart').get(0)
                    })));

                    testSysloadCharts.push(c3.generate(Object.assign(chartConfig.memory, {
                        bindto: $article.find('.test-sysload-memory-chart').get(0)
                    })));
                });

                totalSysloadCharts.push(c3.generate(Object.assign(json.totalCpuChart, {
                    bindto: '#total-sysload-cpu-chart',
                })));

                totalSysloadCharts.push(c3.generate(Object.assign(json.totalMemoryChart, {
                    bindto: '#total-sysload-memory-chart',
                })));

                location.hash = '#overview';
                $( '#nav-list > li[data-id="overview"]' ).addClass('active');

                $(window).on('resize orientationchange', resizeCharts);
                setTimeout(resizeCharts, 1000);
            });
        </script>
    </head>

    <body>
        <header>
            <h1><span>Load testing on</span></h1>
        </header>

        <nav>
            <ul id="nav-list">
                <li data-id="overview">Overview</li>
                <li data-id="requests">Requests</li>
                <li id="nav-tests-list-container"><span>Test</span><ul id="nav-tests-list"></ul></li>
                <li data-id="system-load">System load</li>
            </ul>
        </nav>

        <main>
            <article id="overview">
                <h2>Overview</h2>

                <div class="flex">
                    <section>
                        <h3>Errors</h3>
                        <table id="errors-table">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Subject</th>
                                    <th>Errors</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </section>

                    <section>
                        <h3>Details</h3>
                        <dl id="details-list">
                            <dt data-key="timeStarted">Started</dt>
                            <dd></dd>
                            <dt data-key="timeEnded">Ended</dt>
                            <dd></dd>
                            <dt data-key="cpuCores">CPU cores</dt>
                            <dd></dd>
                            <dt data-key="memory">Memory (GB)</dt>
                            <dd></dd>
                            <dt data-key="sleepDuration">Sleep duration between tests</dt>
                            <dd></dd>
                        </dl>
                    </section>
                </div>
            </article>

            <article id="requests">
                <h2>Requests</h2>
                <div id="requests-chart"></div>
            </article>

            <template id="template-article-test-sysload">
                <article>
                    <h2></h2>

                    <section>
                        <h3>CPU</h3>
                        <div class="test-sysload-cpu-chart"></div>
                    </section>

                    <section>
                        <h3>Memory</h3>
                        <div class="test-sysload-memory-chart"></div>
                    </section>
                </article>
            </template>

            <article id="system-load">
                <h2>System load</h2>

                <section>
                    <h3>CPU</h3>
                    <div id="total-sysload-cpu-chart"></div>
                </section>

                <section>
                    <h3>Memory</h3>
                    <div id="total-sysload-memory-chart"></div>
                </section>
            </article>
        </main>
    </body>
</html>
